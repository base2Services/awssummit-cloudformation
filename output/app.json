{"AWSTemplateFormatVersion":"2010-09-09","Description":"awssummit-demo - App vdev","Parameters":{"EnvironmentType":{"Type":"String"},"EnvironmentName":{"Type":"String"},"VPC":{"Type":"String"},"StackOctet":{"Type":"String"},"RouteTablePrivateA":{"Type":"String"},"SubnetPublicA":{"Type":"String"},"RouteTablePrivateB":{"Type":"String"},"SubnetPublicB":{"Type":"String"},"RouteTablePrivateC":{"Type":"String"},"SubnetPublicC":{"Type":"String"},"SecurityGroupBackplane":{"Type":"String"},"SecurityGroupOps":{"Type":"String"},"SecurityGroupDev":{"Type":"String"}},"Mappings":{"EnvironmentType":{"production":{"AppInstanceType":"t2.small","BastionInstanceType":"t2.micro","AppHealthCheckType":"ELB","StackMask":16,"SubnetMask":24,"NetworkPrefix":10,"AppMinSize":2,"AppMaxSize":6,"MinInstancesInService":1},"dev":{"AppInstanceType":"t2.small","BastionInstanceType":"t2.micro","AppHealthCheckType":"EC2","StackMask":16,"SubnetMask":24,"NetworkPrefix":10,"AppMinSize":2,"AppMaxSize":6,"MinInstancesInService":0}},"AccountId":{"112635491638":{"KeyName":"ciinabox","DnsDomain":"awssummit.base2.services"}},"AppAMI":{"ap-southeast-2":{"ami":"ami-b8cbe8db"}}},"Resources":{"SubnetPrivateA":{"Type":"AWS::EC2::Subnet","Properties":{"VpcId":{"Ref":"VPC"},"CidrBlock":{"Fn::Join":["",[{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"NetworkPrefix"]},".",{"Ref":"StackOctet"},".","3",".0/24"]]},"AvailabilityZone":{"Fn::Select":[0,{"Fn::GetAZs":{"Ref":"AWS::Region"}}]},"Tags":[{"Key":"Name","Value":{"Fn::Join":["",[{"Ref":"EnvironmentName"},"app-privateA"]]}}]}},"SubnetPrivateB":{"Type":"AWS::EC2::Subnet","Properties":{"VpcId":{"Ref":"VPC"},"CidrBlock":{"Fn::Join":["",[{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"NetworkPrefix"]},".",{"Ref":"StackOctet"},".","4",".0/24"]]},"AvailabilityZone":{"Fn::Select":[1,{"Fn::GetAZs":{"Ref":"AWS::Region"}}]},"Tags":[{"Key":"Name","Value":{"Fn::Join":["",[{"Ref":"EnvironmentName"},"app-privateB"]]}}]}},"SubnetPrivateC":{"Type":"AWS::EC2::Subnet","Properties":{"VpcId":{"Ref":"VPC"},"CidrBlock":{"Fn::Join":["",[{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"NetworkPrefix"]},".",{"Ref":"StackOctet"},".","5",".0/24"]]},"AvailabilityZone":{"Fn::Select":[2,{"Fn::GetAZs":{"Ref":"AWS::Region"}}]},"Tags":[{"Key":"Name","Value":{"Fn::Join":["",[{"Ref":"EnvironmentName"},"app-privateC"]]}}]}},"SecurityGroupPublic":{"Type":"AWS::EC2::SecurityGroup","Properties":{"VpcId":{"Ref":"VPC"},"GroupDescription":"Public Access","SecurityGroupIngress":[{"IpProtocol":"tcp","FromPort":"80","ToPort":"80","CidrIp":"0.0.0.0/0"},{"IpProtocol":"tcp","FromPort":"443","ToPort":"443","CidrIp":"0.0.0.0/0"}]}},"SecurityGroupPrivate":{"Type":"AWS::EC2::SecurityGroup","Properties":{"VpcId":{"Ref":"VPC"},"GroupDescription":"ELB Access","SecurityGroupIngress":[{"IpProtocol":"tcp","FromPort":"80","ToPort":"80","CidrIp":{"Fn::Join":["",[{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"NetworkPrefix"]},".",{"Ref":"StackOctet"},".0.0/16"]]}},{"IpProtocol":"tcp","FromPort":"8080","ToPort":"8080","CidrIp":{"Fn::Join":["",[{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"NetworkPrefix"]},".",{"Ref":"StackOctet"},".0.0/16"]]}},{"IpProtocol":"tcp","FromPort":"443","ToPort":"443","CidrIp":{"Fn::Join":["",[{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"NetworkPrefix"]},".",{"Ref":"StackOctet"},".0.0/16"]]}}]}},"SubnetRouteTableAssociationPrivateA":{"Type":"AWS::EC2::SubnetRouteTableAssociation","Properties":{"SubnetId":{"Ref":"SubnetPrivateA"},"RouteTableId":{"Ref":"RouteTablePrivateA"}}},"SubnetRouteTableAssociationPrivateB":{"Type":"AWS::EC2::SubnetRouteTableAssociation","Properties":{"SubnetId":{"Ref":"SubnetPrivateB"},"RouteTableId":{"Ref":"RouteTablePrivateB"}}},"SubnetRouteTableAssociationPrivateC":{"Type":"AWS::EC2::SubnetRouteTableAssociation","Properties":{"SubnetId":{"Ref":"SubnetPrivateC"},"RouteTableId":{"Ref":"RouteTablePrivateC"}}},"Role":{"Type":"AWS::IAM::Role","Properties":{"AssumeRolePolicyDocument":{"Statement":[{"Effect":"Allow","Principal":{"Service":["ec2.amazonaws.com"]},"Action":["sts:AssumeRole"]}]},"Path":"/","Policies":[{"PolicyName":"s3-list-buckets","PolicyDocument":{"Statement":[{"Effect":"Allow","Action":["s3:ListAllMyBuckets","s3:ListBucket"],"Resource":"arn:aws:s3:::*"}]}},{"PolicyName":"chef-read-only","PolicyDocument":{"Statement":[{"Effect":"Allow","Action":["s3:Get*","s3:List*"],"Resource":["arn:aws:s3:::source.demo1.awssummit.base2.services/chef","arn:aws:s3:::source.demo1.awssummit.base2.services/chef/*"]}]}},{"PolicyName":"containers-read-only","PolicyDocument":{"Statement":[{"Effect":"Allow","Action":["s3:Get*","s3:List*"],"Resource":["arn:aws:s3:::source.demo1.awssummit.base2.services/containers","arn:aws:s3:::source.demo1.awssummit.base2.services/containers/*"]}]}},{"PolicyName":"ssh-key-download","PolicyDocument":{"Statement":[{"Effect":"Allow","Action":["s3:Get*","s3:List*"],"Resource":["arn:aws:s3:::source.demo1.awssummit.base2.services/keys","arn:aws:s3:::source.demo1.awssummit.base2.services/keys/*"]}]}},{"PolicyName":"codedeploy-read-only","PolicyDocument":{"Statement":[{"Effect":"Allow","Action":["s3:Get*","s3:List*"],"Resource":["arn:aws:s3:::source.demo1.awssummit.base2.services'.au/codedeploy","arn:aws:s3:::source.demo1.awssummit.base2.services/codedeploy/*"]}]}},{"PolicyName":"container-read-only","PolicyDocument":{"Statement":[{"Effect":"Allow","Action":["s3:Get*","s3:List*"],"Resource":["arn:aws:s3:::source.demo1.awssummit.base2.services/containers","arn:aws:s3:::source.demo1.awssummit.base2.services/codedeploy/*"]}]}},{"PolicyName":"elb-asg-register-deregister","PolicyDocument":{"Statement":[{"Effect":"Allow","Action":["ec2:Describe*","elasticloadbalancing:Describe*","elasticloadbalancing:DeregisterInstancesFromLoadBalancer","elasticloadbalancing:RegisterInstancesWithLoadBalancer","autoscaling:Describe*","autoscaling:EnterStandby","autoscaling:ExitStandby","autoscaling:UpdateAutoScalingGroup"],"Resource":"*"}]}},{"PolicyName":"packages-read-only","PolicyDocument":{"Statement":[{"Effect":"Allow","Action":["s3:Get*","s3:List*"],"Resource":["arn:aws:s3:::source.demo1.awssummit.base2.services/packages","arn:aws:s3:::source.demo1.awssummit.base2.services/packages/*"]}]}}]}},"CodeDeployRole":{"Type":"AWS::IAM::Role","Properties":{"AssumeRolePolicyDocument":{"Statement":[{"Effect":"Allow","Principal":{"Service":["codedeploy.ap-southeast-2.amazonaws.com"]},"Action":["sts:AssumeRole"]}]},"Path":"/","Policies":[{"PolicyName":"CodeDeployRole","PolicyDocument":{"Statement":[{"Effect":"Allow","Action":["autoscaling:CompleteLifecycleAction","autoscaling:DeleteLifecycleHook","autoscaling:DescribeAutoScalingGroups","autoscaling:DescribeLifecycleHooks","autoscaling:PutLifecycleHook","autoscaling:RecordLifecycleActionHeartbeat","ec2:DescribeInstances","ec2:DescribeInstanceStatus","tag:GetTags","tag:GetResources"],"Resource":"*"}]}}]}},"InstanceProfile":{"Type":"AWS::IAM::InstanceProfile","Properties":{"Path":"/","Roles":[{"Ref":"Role"}]}},"LaunchConfig":{"Properties":{"ImageId":{"Fn::FindInMap":["AppAMI",{"Ref":"AWS::Region"},"ami"]},"IamInstanceProfile":{"Ref":"InstanceProfile"},"KeyName":{"Fn::FindInMap":["AccountId",{"Ref":"AWS::AccountId"},"KeyName"]},"SecurityGroups":[{"Ref":"SecurityGroupBackplane"},{"Ref":"SecurityGroupPrivate"}],"InstanceType":{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"AppInstanceType"]},"UserData":{"Fn::Base64":{"Fn::Join":["",["#!/bin/bash\n","hostname ",{"Ref":"EnvironmentName"},"-","app-xx-`/opt/aws/bin/ec2-metadata --instance-id|/usr/bin/awk '{print $2}'`\n","sed '/HOSTNAME/d' /etc/sysconfig/network > /tmp/network && mv -f /tmp/network /etc/sysconfig/network && echo \"HOSTNAME=",{"Ref":"EnvironmentName"},"-","app-xx-`/opt/aws/bin/ec2-metadata --instance-id|/usr/bin/awk '{print $2}'`\" >>/etc/sysconfig/network && /etc/init.d/network restart\n","wget -O /tmp/code_deploy_install https://aws-codedeploy-ap-southeast-2.s3.amazonaws.com/latest/install\n","chmod 744 /tmp/install\n","/tmp/code_deploy_install auto\n","service codedeploy-agent start\n","echo done!!!\n"]]}}},"Type":"AWS::AutoScaling::LaunchConfiguration"},"AutoScaleGroup":{"UpdatePolicy":{"AutoScalingRollingUpdate":{"MinInstancesInService":{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"MinInstancesInService"]},"MaxBatchSize":"1"}},"Properties":{"AvailabilityZones":[{"Fn::Select":["0",{"Fn::GetAZs":{"Ref":"AWS::Region"}}]},{"Fn::Select":["1",{"Fn::GetAZs":{"Ref":"AWS::Region"}}]},{"Fn::Select":["2",{"Fn::GetAZs":{"Ref":"AWS::Region"}}]}],"LaunchConfigurationName":{"Ref":"LaunchConfig"},"LoadBalancerNames":[{"Ref":"ElasticLoadBalancer"}],"HealthCheckGracePeriod":"500","HealthCheckType":{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"AppHealthCheckType"]},"MinSize":{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"AppMinSize"]},"MaxSize":{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"AppMaxSize"]},"VPCZoneIdentifier":[{"Ref":"SubnetPrivateA"},{"Ref":"SubnetPrivateB"},{"Ref":"SubnetPrivateC"}],"Tags":[{"Key":"Name","Value":{"Fn::Join":["",[{"Ref":"EnvironmentName"},"-app-xx"]]},"PropagateAtLaunch":true},{"Key":"Environment","Value":{"Ref":"EnvironmentName"},"PropagateAtLaunch":true},{"Key":"EnvironmentType","Value":{"Ref":"EnvironmentType"},"PropagateAtLaunch":true},{"Key":"Role","Value":"awssummit::app","PropagateAtLaunch":true}]},"Type":"AWS::AutoScaling::AutoScalingGroup"},"ElasticLoadBalancer":{"Type":"AWS::ElasticLoadBalancing::LoadBalancer","Properties":{"Listeners":[{"LoadBalancerPort":"80","InstancePort":"8080","Protocol":"HTTP"}],"HealthCheck":{"Target":"TCP:8080","HealthyThreshold":"3","UnhealthyThreshold":"2","Interval":"15","Timeout":"5"},"ConnectionDrainingPolicy":{"Enabled":"true","Timeout":"300"},"CrossZone":true,"SecurityGroups":[{"Ref":"SecurityGroupPublic"},{"Ref":"SecurityGroupOps"},{"Ref":"SecurityGroupDev"}],"Subnets":[{"Ref":"SubnetPublicA"},{"Ref":"SubnetPublicB"}],"LoadBalancerName":{"Fn::Join":["",[{"Ref":"EnvironmentName"},"-app"]]}}},"LoadBalancerRecord":{"Type":"AWS::Route53::RecordSet","Properties":{"HostedZoneName":{"Fn::Join":["",[{"Ref":"EnvironmentName"},".",{"Fn::FindInMap":["AccountId",{"Ref":"AWS::AccountId"},"DnsDomain"]},"."]]},"Name":{"Fn::Join":["",["app",".",{"Ref":"EnvironmentName"},".",{"Fn::FindInMap":["AccountId",{"Ref":"AWS::AccountId"},"DnsDomain"]},"."]]},"Type":"A","AliasTarget":{"DNSName":{"Fn::GetAtt":["ElasticLoadBalancer","DNSName"]},"HostedZoneId":{"Fn::GetAtt":["ElasticLoadBalancer","CanonicalHostedZoneNameID"]}}}},"ScaleUpPolicy":{"Type":"AWS::AutoScaling::ScalingPolicy","Properties":{"AdjustmentType":"ChangeInCapacity","AutoScalingGroupName":{"Ref":"AutoScaleGroup"},"Cooldown":"300","ScalingAdjustment":"1"}},"ScaleDownPolicy":{"Type":"AWS::AutoScaling::ScalingPolicy","Properties":{"AdjustmentType":"ChangeInCapacity","AutoScalingGroupName":{"Ref":"AutoScaleGroup"},"Cooldown":"300","ScalingAdjustment":"-1"}},"CPUAlarmHigh":{"Type":"AWS::CloudWatch::Alarm","Properties":{"AlarmDescription":"Scale-up if CPU > 60% for 2 minutes","MetricName":"CPUUtilization","Namespace":"AWS/EC2","Statistic":"Average","Period":"60","EvaluationPeriods":"2","Threshold":"60","AlarmActions":[{"Ref":"ScaleUpPolicy"}],"Dimensions":[{"Name":"AutoScalingGroupName","Value":{"Ref":"AutoScaleGroup"}}],"ComparisonOperator":"GreaterThanThreshold"}},"CPUAlarmLow":{"Type":"AWS::CloudWatch::Alarm","Properties":{"AlarmDescription":"Scale-up if CPU < 40% for 4 minutes","MetricName":"CPUUtilization","Namespace":"AWS/EC2","Statistic":"Average","Period":"60","EvaluationPeriods":"4","Threshold":"30","AlarmActions":[{"Ref":"ScaleDownPolicy"}],"Dimensions":[{"Name":"AutoScalingGroupName","Value":{"Ref":"AutoScaleGroup"}}],"ComparisonOperator":"LessThanThreshold"}}},"Outputs":{"AutoScaleGroup":{"Value":{"Ref":"AutoScaleGroup"}}}}
