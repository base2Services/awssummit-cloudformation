{"AWSTemplateFormatVersion":"2010-09-09","Description":"awssummit-demo - VPC vdev","Parameters":{"EnvironmentType":{"Type":"String"},"EnvironmentName":{"Type":"String"},"StackOctet":{"Type":"String","AllowedPattern":"[0-9]*"},"NatAEIPAllocationId":{"Type":"String"},"NatBEIPAllocationId":{"Type":"String"},"NatCEIPAllocationId":{"Type":"String"}},"Mappings":{"EnvironmentType":{"production":{"AppInstanceType":"t2.small","BastionInstanceType":"t2.micro","AppHealthCheckType":"ELB","StackMask":16,"SubnetMask":24,"NetworkPrefix":10,"AppMinSize":2,"AppMaxSize":6,"MinInstancesInService":1},"dev":{"AppInstanceType":"t2.small","BastionInstanceType":"t2.micro","AppHealthCheckType":"EC2","StackMask":16,"SubnetMask":24,"NetworkPrefix":10,"AppMinSize":2,"AppMaxSize":6,"MinInstancesInService":0}},"AccountId":{"112635491638":{"KeyName":"ciinabox","DnsDomain":"awssummit.base2.services"}},"BastionAMI":{"ap-southeast-2":{"ami":"ami-f2210191"}}},"Resources":{"VPC":{"Type":"AWS::EC2::VPC","Properties":{"CidrBlock":{"Fn::Join":["",[{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"NetworkPrefix"]},".",{"Ref":"StackOctet"},".0.0/",{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"StackMask"]}]]},"EnableDnsSupport":true,"EnableDnsHostnames":true}},"HostedZone":{"Type":"AWS::Route53::HostedZone","Properties":{"Name":{"Fn::Join":[".",[{"Ref":"EnvironmentName"},{"Fn::FindInMap":["AccountId",{"Ref":"AWS::AccountId"},"DnsDomain"]}]]}}},"SubnetPublicA":{"Type":"AWS::EC2::Subnet","Properties":{"VpcId":{"Ref":"VPC"},"CidrBlock":{"Fn::Join":["",[{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"NetworkPrefix"]},".",{"Ref":"StackOctet"},".","0",".0/",{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"SubnetMask"]}]]},"AvailabilityZone":{"Fn::Select":[0,{"Fn::GetAZs":{"Ref":"AWS::Region"}}]},"Tags":[{"Key":"Name","Value":{"Fn::Join":["",[{"Ref":"EnvironmentName"},"-publicA"]]}}]}},"SubnetPublicB":{"Type":"AWS::EC2::Subnet","Properties":{"VpcId":{"Ref":"VPC"},"CidrBlock":{"Fn::Join":["",[{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"NetworkPrefix"]},".",{"Ref":"StackOctet"},".","1",".0/",{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"SubnetMask"]}]]},"AvailabilityZone":{"Fn::Select":[1,{"Fn::GetAZs":{"Ref":"AWS::Region"}}]},"Tags":[{"Key":"Name","Value":{"Fn::Join":["",[{"Ref":"EnvironmentName"},"-publicB"]]}}]}},"SubnetPublicC":{"Type":"AWS::EC2::Subnet","Properties":{"VpcId":{"Ref":"VPC"},"CidrBlock":{"Fn::Join":["",[{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"NetworkPrefix"]},".",{"Ref":"StackOctet"},".","2",".0/",{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"SubnetMask"]}]]},"AvailabilityZone":{"Fn::Select":[2,{"Fn::GetAZs":{"Ref":"AWS::Region"}}]},"Tags":[{"Key":"Name","Value":{"Fn::Join":["",[{"Ref":"EnvironmentName"},"-publicC"]]}}]}},"InternetGateway":{"Type":"AWS::EC2::InternetGateway"},"AttachGateway":{"Type":"AWS::EC2::VPCGatewayAttachment","Properties":{"VpcId":{"Ref":"VPC"},"InternetGatewayId":{"Ref":"InternetGateway"}}},"NatIPAddressA":{"Type":"AWS::EC2::EIP","Properties":{"Domain":"vpc"},"DependsOn":["AttachGateway"],"Condition":"NatAEIPRequired"},"NatIPAddressB":{"Type":"AWS::EC2::EIP","Properties":{"Domain":"vpc"},"DependsOn":["AttachGateway"],"Condition":"NatBEIPRequired"},"NatIPAddressC":{"Type":"AWS::EC2::EIP","Properties":{"Domain":"vpc"},"DependsOn":["AttachGateway"],"Condition":"NatCEIPRequired"},"BastionIPAddress":{"Type":"AWS::EC2::EIP","Properties":{"Domain":"vpc"},"DependsOn":["AttachGateway"]},"NatGatewayA":{"Type":"AWS::EC2::NatGateway","Properties":{"AllocationId":{"Fn::GetAtt":["NatIPAddressA","AllocationId"]},"SubnetId":{"Ref":"SubnetPublicA"}}},"NatGatewayB":{"Type":"AWS::EC2::NatGateway","Properties":{"AllocationId":{"Fn::GetAtt":["NatIPAddressB","AllocationId"]},"SubnetId":{"Ref":"SubnetPublicB"}}},"NatGatewayC":{"Type":"AWS::EC2::NatGateway","Properties":{"AllocationId":{"Fn::GetAtt":["NatIPAddressC","AllocationId"]},"SubnetId":{"Ref":"SubnetPublicC"}}},"RouteTablePublic":{"Type":"AWS::EC2::RouteTable","Properties":{"VpcId":{"Ref":"VPC"},"Tags":[{"Key":"Name","Value":{"Fn::Join":["",[{"Ref":"EnvironmentName"},"-public"]]}}]}},"RouteTablePrivateA":{"Type":"AWS::EC2::RouteTable","Properties":{"VpcId":{"Ref":"VPC"},"Tags":[{"Key":"Name","Value":{"Fn::Join":["",[{"Ref":"EnvironmentName"},"-privateA"]]}}]}},"RouteTablePrivateB":{"Type":"AWS::EC2::RouteTable","Properties":{"VpcId":{"Ref":"VPC"},"Tags":[{"Key":"Name","Value":{"Fn::Join":["",[{"Ref":"EnvironmentName"},"-privateB"]]}}]}},"RouteTablePrivateC":{"Type":"AWS::EC2::RouteTable","Properties":{"VpcId":{"Ref":"VPC"},"Tags":[{"Key":"Name","Value":{"Fn::Join":["",[{"Ref":"EnvironmentName"},"-privateC"]]}}]}},"SubnetRouteTableAssociationPublicA":{"Type":"AWS::EC2::SubnetRouteTableAssociation","Properties":{"SubnetId":{"Ref":"SubnetPublicA"},"RouteTableId":{"Ref":"RouteTablePublic"}}},"SubnetRouteTableAssociationPublicB":{"Type":"AWS::EC2::SubnetRouteTableAssociation","Properties":{"SubnetId":{"Ref":"SubnetPublicB"},"RouteTableId":{"Ref":"RouteTablePublic"}}},"SubnetRouteTableAssociationPublicC":{"Type":"AWS::EC2::SubnetRouteTableAssociation","Properties":{"SubnetId":{"Ref":"SubnetPublicC"},"RouteTableId":{"Ref":"RouteTablePublic"}}},"PublicRouteOutToInternet":{"Type":"AWS::EC2::Route","Properties":{"RouteTableId":{"Ref":"RouteTablePublic"},"DestinationCidrBlock":"0.0.0.0/0","GatewayId":{"Ref":"InternetGateway"}},"DependsOn":["AttachGateway"]},"PublicNetworkAcl":{"Type":"AWS::EC2::NetworkAcl","Properties":{"VpcId":{"Ref":"VPC"}}},"InboundHTTPPublicNetworkAclEntry":{"Type":"AWS::EC2::NetworkAclEntry","Properties":{"NetworkAclId":{"Ref":"PublicNetworkAcl"},"RuleNumber":"100","Protocol":"6","RuleAction":"allow","Egress":"false","CidrBlock":"0.0.0.0/0","PortRange":{"From":"80","To":"80"}}},"InboundHTTPSPublicNetworkAclEntry":{"Type":"AWS::EC2::NetworkAclEntry","Properties":{"NetworkAclId":{"Ref":"PublicNetworkAcl"},"RuleNumber":"101","Protocol":"6","RuleAction":"allow","Egress":"false","CidrBlock":"0.0.0.0/0","PortRange":{"From":"443","To":"443"}}},"InboundSSHPublicNetworkAclEntry":{"Type":"AWS::EC2::NetworkAclEntry","Properties":{"NetworkAclId":{"Ref":"PublicNetworkAcl"},"RuleNumber":"102","Protocol":"6","RuleAction":"allow","Egress":"false","CidrBlock":"0.0.0.0/0","PortRange":{"From":"22","To":"22"}}},"InboundNTPPublicNetworkAclEntry":{"Type":"AWS::EC2::NetworkAclEntry","Properties":{"NetworkAclId":{"Ref":"PublicNetworkAcl"},"RuleNumber":"103","Protocol":"17","RuleAction":"allow","Egress":"true","CidrBlock":"0.0.0.0/0","PortRange":{"From":"123","To":"123"}}},"InboundEphemeralPublicNetworkAclEntry":{"Type":"AWS::EC2::NetworkAclEntry","Properties":{"NetworkAclId":{"Ref":"PublicNetworkAcl"},"RuleNumber":"104","Protocol":"6","RuleAction":"allow","Egress":"false","CidrBlock":"0.0.0.0/0","PortRange":{"From":"1024","To":"65535"}}},"OutboundNetworkAclEntry":{"Type":"AWS::EC2::NetworkAclEntry","Properties":{"NetworkAclId":{"Ref":"PublicNetworkAcl"},"RuleNumber":"105","Protocol":"-1","RuleAction":"allow","Egress":"true","CidrBlock":"0.0.0.0/0","PortRange":{"From":"0","To":"65535"}}},"SubnetNetworkAclAssociationPublicA":{"Type":"AWS::EC2::SubnetNetworkAclAssociation","Properties":{"SubnetId":{"Ref":"SubnetPublicA"},"NetworkAclId":{"Ref":"PublicNetworkAcl"}}},"SubnetNetworkAclAssociationPublicB":{"Type":"AWS::EC2::SubnetNetworkAclAssociation","Properties":{"SubnetId":{"Ref":"SubnetPublicB"},"NetworkAclId":{"Ref":"PublicNetworkAcl"}}},"SubnetNetworkAclAssociationPublicC":{"Type":"AWS::EC2::SubnetNetworkAclAssociation","Properties":{"SubnetId":{"Ref":"SubnetPublicC"},"NetworkAclId":{"Ref":"PublicNetworkAcl"}}},"DHCPOptionSet":{"Type":"AWS::EC2::DHCPOptions","Properties":{"DomainName":{"Fn::Join":[".",[{"Ref":"EnvironmentName"},{"Fn::FindInMap":["AccountId",{"Ref":"AWS::AccountId"},"DnsDomain"]}]]},"DomainNameServers":["AmazonProvidedDNS"]}},"DHCPOptionsAssociation":{"Type":"AWS::EC2::VPCDHCPOptionsAssociation","Properties":{"VpcId":{"Ref":"VPC"},"DhcpOptionsId":{"Ref":"DHCPOptionSet"}}},"SecurityGroupOps":{"Type":"AWS::EC2::SecurityGroup","Properties":{"VpcId":{"Ref":"VPC"},"GroupDescription":"Ops External Access","SecurityGroupIngress":[{"IpProtocol":"tcp","FromPort":"22","ToPort":"22","CidrIp":"52.64.2.223/32"},{"IpProtocol":"tcp","FromPort":"80","ToPort":"80","CidrIp":"52.64.2.223/32"},{"IpProtocol":"tcp","FromPort":"443","ToPort":"443","CidrIp":"52.64.2.223/32"}]}},"SecurityGroupDev":{"Type":"AWS::EC2::SecurityGroup","Properties":{"VpcId":{"Ref":"VPC"},"GroupDescription":"Dev Team Access","SecurityGroupIngress":[{"IpProtocol":"tcp","FromPort":"22","ToPort":"22","CidrIp":"52.64.2.223/32"},{"IpProtocol":"tcp","FromPort":"80","ToPort":"80","CidrIp":"52.64.2.223/32"},{"IpProtocol":"tcp","FromPort":"443","ToPort":"443","CidrIp":"52.64.2.223/32"}]}},"SecurityGroupBackplane":{"Type":"AWS::EC2::SecurityGroup","Properties":{"VpcId":{"Ref":"VPC"},"GroupDescription":"Backplane SG","SecurityGroupIngress":[{"IpProtocol":"tcp","FromPort":"3389","ToPort":"3389","CidrIp":{"Fn::Join":["",[{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"NetworkPrefix"]},".",{"Ref":"StackOctet"},".0.0/",{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"StackMask"]}]]}},{"IpProtocol":"tcp","FromPort":"22","ToPort":"22","CidrIp":{"Fn::Join":["",[{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"NetworkPrefix"]},".",{"Ref":"StackOctet"},".0.0/",{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"StackMask"]}]]}},{"IpProtocol":"tcp","FromPort":"80","ToPort":"80","CidrIp":{"Fn::Join":["",[{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"NetworkPrefix"]},".",{"Ref":"StackOctet"},".0.0/",{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"StackMask"]}]]}},{"IpProtocol":"tcp","FromPort":"443","ToPort":"443","CidrIp":{"Fn::Join":["",[{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"NetworkPrefix"]},".",{"Ref":"StackOctet"},".0.0/",{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"StackMask"]}]]}},{"IpProtocol":"udp","FromPort":"123","ToPort":"123","CidrIp":{"Fn::Join":["",[{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"NetworkPrefix"]},".",{"Ref":"StackOctet"},".0.0/",{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"StackMask"]}]]}}]}},"SecurityGroupInternalNat":{"Type":"AWS::EC2::SecurityGroup","Properties":{"VpcId":{"Ref":"VPC"},"GroupDescription":"Internal NAT SG","SecurityGroupIngress":[{"IpProtocol":"tcp","FromPort":"1","ToPort":"65535","CidrIp":{"Fn::Join":["",[{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"NetworkPrefix"]},".",{"Ref":"StackOctet"},".0.0/",{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"StackMask"]}]]}}]}},"Role":{"Type":"AWS::IAM::Role","Properties":{"AssumeRolePolicyDocument":{"Statement":[{"Effect":"Allow","Principal":{"Service":["ec2.amazonaws.com"]},"Action":["sts:AssumeRole"]}]},"Path":"/","Policies":[{"PolicyName":"read-only","PolicyDocument":{"Statement":[{"Effect":"Allow","Action":["ec2:Describe*","s3:Get*","s3:List*"],"Resource":"*"}]}},{"PolicyName":"describe-ec2-autoscaling","PolicyDocument":{"Statement":[{"Effect":"Allow","Action":["ec2:Describe*","autoscaling:Describe*"],"Resource":"*"}]}},{"PolicyName":"associate-address","PolicyDocument":{"Statement":[{"Effect":"Allow","Action":["ec2:AssociateAddress"],"Resource":"*"}]}}]}},"InstanceProfile":{"Type":"AWS::IAM::InstanceProfile","Properties":{"Path":"/","Roles":[{"Ref":"Role"}]}},"RouteOutToInternetA":{"Type":"AWS::EC2::Route","Properties":{"RouteTableId":{"Ref":"RouteTablePrivateA"},"DestinationCidrBlock":"0.0.0.0/0","NatGatewayId":{"Ref":"NatGatewayA"}}},"RouteOutToInternetB":{"Type":"AWS::EC2::Route","Properties":{"RouteTableId":{"Ref":"RouteTablePrivateB"},"DestinationCidrBlock":"0.0.0.0/0","NatGatewayId":{"Ref":"NatGatewayB"}}},"RouteOutToInternetC":{"Type":"AWS::EC2::Route","Properties":{"RouteTableId":{"Ref":"RouteTablePrivateC"},"DestinationCidrBlock":"0.0.0.0/0","NatGatewayId":{"Ref":"NatGatewayC"}}},"VPCEndpoint":{"Type":"AWS::EC2::VPCEndpoint","Properties":{"PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Principal":"*","Action":["s3:*"],"Resource":["arn:aws:s3:::*"]}]},"RouteTableIds":[{"Ref":"RouteTablePrivateA"},{"Ref":"RouteTablePrivateB"},{"Ref":"RouteTablePrivateC"}],"ServiceName":{"Fn::Join":["",["com.amazonaws.",{"Ref":"AWS::Region"},".s3"]]},"VpcId":{"Ref":"VPC"}}},"LaunchConfig":{"Type":"AWS::AutoScaling::LaunchConfiguration","Properties":{"ImageId":{"Fn::FindInMap":["BastionAMI",{"Ref":"AWS::Region"},"ami"]},"AssociatePublicIpAddress":true,"IamInstanceProfile":{"Ref":"InstanceProfile"},"KeyName":{"Fn::FindInMap":["AccountId",{"Ref":"AWS::AccountId"},"KeyName"]},"SecurityGroups":[{"Ref":"SecurityGroupBackplane"},{"Ref":"SecurityGroupInternalNat"},{"Ref":"SecurityGroupOps"},{"Ref":"SecurityGroupDev"}],"InstanceType":{"Fn::FindInMap":["EnvironmentType",{"Ref":"EnvironmentType"},"BastionInstanceType"]},"UserData":{"Fn::Base64":{"Fn::Join":["",["#!/bin/bash\n","export NEW_HOSTNAME=",{"Ref":"EnvironmentName"},"-bastion-xx-`/opt/aws/bin/ec2-metadata --instance-id|/usr/bin/awk '{print $2}'`\n","echo \"NEW_HOSTNAME=$NEW_HOSTNAME\" \n","hostname $NEW_HOSTNAME\n","sed -i \"s/^HOSTNAME=.*/HOSTNAME=$NEW_HOSTNAME/\" /etc/sysconfig/network\n","aws --region ",{"Ref":"AWS::Region"}," ec2 associate-address --allocation-id ",{"Fn::GetAtt":["BastionIPAddress","AllocationId"]}," --instance-id $(curl http://169.254.169.254/2014-11-05/meta-data/instance-id -s)\n"]]}}}},"AutoScaleGroup":{"UpdatePolicy":{"AutoScalingRollingUpdate":{"MinInstancesInService":"0","MaxBatchSize":"1"}},"Properties":{"LaunchConfigurationName":{"Ref":"LaunchConfig"},"HealthCheckGracePeriod":"500","MinSize":1,"MaxSize":1,"VPCZoneIdentifier":[{"Ref":"SubnetPublicA"},{"Ref":"SubnetPublicB"},{"Ref":"SubnetPublicC"}],"Tags":[{"Key":"Name","Value":{"Fn::Join":["",[{"Ref":"EnvironmentName"},"-bastion-xx"]]},"PropagateAtLaunch":true},{"Key":"Environment","Value":{"Ref":"EnvironmentName"},"PropagateAtLaunch":true},{"Key":"EnvironmentType","Value":{"Ref":"EnvironmentType"},"PropagateAtLaunch":true},{"Key":"Role","Value":"bastion","PropagateAtLaunch":true}]},"Type":"AWS::AutoScaling::AutoScalingGroup"},"BastionRecord":{"Type":"AWS::Route53::RecordSet","Properties":{"HostedZoneId":{"Ref":"HostedZone"},"Name":{"Fn::Join":["",["bastion.",{"Ref":"EnvironmentName"},".",{"Fn::FindInMap":["AccountId",{"Ref":"AWS::AccountId"},"DnsDomain"]},"."]]},"Type":"A","TTL":"60","ResourceRecords":[{"Ref":"BastionIPAddress"}]}}},"Outputs":{"VPCId":{"Value":{"Ref":"VPC"}},"RouteTablePrivateA":{"Value":{"Ref":"RouteTablePrivateA"}},"RouteTablePrivateB":{"Value":{"Ref":"RouteTablePrivateB"}},"RouteTablePrivateC":{"Value":{"Ref":"RouteTablePrivateC"}},"SubnetPublicA":{"Value":{"Ref":"SubnetPublicA"}},"SubnetPublicB":{"Value":{"Ref":"SubnetPublicB"}},"SubnetPublicC":{"Value":{"Ref":"SubnetPublicC"}},"SecurityGroupBackplane":{"Value":{"Ref":"SecurityGroupBackplane"}},"SecurityGroupOps":{"Value":{"Ref":"SecurityGroupOps"}},"SecurityGroupDev":{"Value":{"Ref":"SecurityGroupDev"}}},"Conditions":{"NatAEIPRequired":{"Fn::Equals":[{"Ref":"NatAEIPAllocationId"},"dynamic"]},"NatBEIPRequired":{"Fn::Equals":[{"Ref":"NatBEIPAllocationId"},"dynamic"]},"NatCEIPRequired":{"Fn::Equals":[{"Ref":"NatCEIPAllocationId"},"dynamic"]}}}
